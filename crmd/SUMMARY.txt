= 2. 内容 =
== 2.1 crmd ==
 * 構成時のメッセージの流れの概要
  1. 初期起動処理を実行
  1. election_triggerタイマーをセットする
  1. CRM_OP_JOIN_ANNOUNCEメッセージ送信(起動済みのDC探索)
  1. 応答の有無によって処理が変わる
   * DCが存在しなければDCから応答がない場合は、election_triggerタイマーが発動し、5へ
   * DCが存在する場合は、DCノードがCRM_OP_JOIN_ANNOUNCEに応答して、CRM_OP_JOIN_OFFERメッセージを送ってきたノードへ返信し、7へ....
  1. CRM_OP_VOTEメッセージ送信
   * election_timeoutタイマーを仕掛ける
  1. CRM_OP_VOTEメッセージを受信
    * do_election_count_vote()処理を実施
     * votedハッシュテーブルには、DCになれそうなノードのみが積み上げを行う
     * DCになれないノードはここでCRM_OP_NOVOTEメッセージを送信
      * DCになれないノードは、election_timeoutタイマーもキャンセルする
      * DCになれそうなノードは、election_timeoutタイマーをキャンセルしないので、DCになれるならelection_timeoutタイマーが発動する
    * do_election_check()処理を実施
     * 構成予定メンバーでCRM_OP_VOTEメッセージのやり取りが終了し場合は(voteハッシュテーブルに構成予定メンバーの情報が揃った)、メンバーのcrmd宛てにCRM_OP_JOIN_OFFERメッセージを送信(DCノードからしか実行されない)
      * CRM_OP_JOIN_OFFERメッセージ送信前に、DCとして自ノードを決定して、tengine部起動、pengine起動
    * →もしくは、election_timeoutタイマーが発動して処理が進み、構成メンバーの情報が揃った時（上記と同様)に...メンバーのcrmd宛てにCRM_OP_JOIN_OFFERメッセージを送信
  1. CRM_OP_JOIN_OFFERメッセージを受信
   * DCをセットして、CRM_OP_JOIN_REQUESTをDCに送信
  1. CRM_OP_JOIN_REQUESTメッセージを受信
   * DCノードは構成予定メンバーからのCRM_OP_JOIN_REQUEST受信待ち状態
    * 受信完了後に、CRM_OP_JOIN_ACKNAKメッセージをメンバーに送信(CRMD_JOINSTATE_MEMBERならCRM_OP_JOIN_ACKNAKはTRUE,その他はFALSE)
  1. CRM_OP_JOIN_ACKNAKメッセージ受信
   * DCをセット
   * CRM_OP_JOIN_CONFIRMメッセージをDCに送信
  1. CRM_OP_JOIN_CONFIRMメッセージ受信
   * 構成予定メンバーでCRM_OP_JOIN_REQUESTメッセージ、CRM_OP_JOIN_CONFIRMメッセージのやり取りが終了し場合は、pengineへの状態遷移作成依頼
 * タイマー
 * クラスタ構成時のメッセージ関連の管理ハッシュテーブル
  * vote
   * CRM_OP_VOTEメッセージのやり取り中に自ノードからのCRM_OP_VOTEメッセージ、DCになれないと判断した他ノードからのCRM_OP_NOVOTEメッセージを受信した場合に追加される
   * 最終的に、DCノードのみで構成予定メンバーの全ての情報が入ることになる.
    * CRM_OP_VOTEメッセージ、CRM_OP_NOVOTEメッセージを全て受信するのは、DCになるノードのみの為
   * DC決定(tengine部起動、pengine起動の前:do_dc_takeover()処理)した時に破棄 
  * welcomed_nodes
   * DCがCRM_OP_JOIN_OFFERを送信したノード
  * integrated_nodes 
   * DCからCRM_OP_JOIN_OFFERを受信してCRM_OP_JOIN_REQUESTを送信して来たノード
   * この時点で、welcomed_nodesからは削除
  * finalized_nodes
   * 全てのメンバーからCRM_OP_JOIN_REQUESTメッセージを受信後(welcomed_nodesハッシュテーブルがサイズ０）、DCノードからCRM_OP_JOIN_ACKNAKを送信したリスト
   * この時点で、integrated_nodesからは削除
  * confirmed_nodes
   * DCノードからCRM_OP_JOIN_ACKNAKを受信してCRM_OP_JOIN_CONFIRMを送信して来たノード
   * この時点で、finalized_nodesからは削除
   * confirmed_nodesは、稼動中は保持
    * よって、段階的に処理が綺麗に進むと、この時点では、welcomed_nodes、integrated_nodes、finalized_nodesは全てサイズが０になっていることになる。